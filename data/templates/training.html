<div class="container">
    <div class="step-indicator">
        <div class="step">1</div>
        <div class="step">2</div>
        <div class="step">3</div>
        <div class="step">4</div>
        <div class="step active">5</div>
    </div>
    <link rel="stylesheet" href="/static/style.css">

    <h2>ü§ñ –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏</h2>
    <div id="trainingStatus">
        <div class="loader"></div>
        <p style="text-align: center; color: #666;">–ò–¥–µ—Ç –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –∏ –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏...</p>
        <div class="progress-bar">
            <div class="progress"></div>
        </div>
    </div>
    
    <div id="result" style="display: none;">
        <h3 style="color: var(--accent);">üéâ –û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</h3>
        <p>–¢–æ—á–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏: <span id="accuracy" style="font-weight: 600;"></span></p>
        <div class="risk-summary">
            <h4>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:</h4>
            <p>–†–∏—Å–∫-–ø—Ä–æ—Ñ–∏–ª—å: <span id="riskProfile"></span></p>
            <p>Take-profit/Stop-loss: <span id="tpslValue"></span></p>
        </div>
        <div style="margin-top: 25px;">
            <button class="btn" onclick="location.href='/'">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
        </div>
    </div>
</div>

<script>
    async function startTraining() {
        try {
            // 1. –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            const response = await fetch('/train', { method: 'POST' });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const { task_id } = await response.json();

            // 2. –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
            trackProgress(task_id);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –æ–±—É—á–µ–Ω–∏—è:', error);
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏');
        }
    }

    async function trackProgress(task_id) {
        const progressBar = document.querySelector('.progress');
        const interval = setInterval(async () => {
            try {
                // 3. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 1.5 —Å–µ–∫—É–Ω–¥—ã
                const response = await fetch(`/status/${task_id}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const status = await response.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                if (progressBar) {
                    progressBar.style.width = `${status.progress}%`;
                }
                
                // 4. –ï—Å–ª–∏ –æ–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
                if (status.status === 'completed') {
                    clearInterval(interval);
                    showResults(status);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
                clearInterval(interval);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ–±—É—á–µ–Ω–∏—è');
            }
        }, 1500);
    }

    function showResults(status) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        document.getElementById('accuracy').textContent = status.accuracy;
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ä–∏—Å–∫-–ø—Ä–æ—Ñ–∏–ª—å
        const riskText = status.risk_profile === 'low' ? '–ù–∏–∑–∫–∏–π' :
                      status.risk_profile === 'medium' ? '–°—Ä–µ–¥–Ω–∏–π' : '–í—ã—Å–æ–∫–∏–π';
        
        document.getElementById('riskProfile').textContent = riskText;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è TP/SL
        const tpslValue = status.risk_profile === 'low' ? '5-10%' :
                       status.risk_profile === 'medium' ? '10-15%' : '15-25%';
        
        document.getElementById('tpslValue').textContent = tpslValue;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        setTimeout(() => {
            document.getElementById('trainingStatus').style.display = 'none';
            document.getElementById('result').style.display = 'block';
        }, 500);
    }

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        
        const container = document.querySelector('.container');
        container.insertBefore(errorDiv, container.firstChild);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
        const restartBtn = document.createElement('button');
        restartBtn.className = 'btn';
        restartBtn.textContent = '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';
        restartBtn.onclick = () => location.reload();
        
        container.appendChild(restartBtn);
    }

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å
    document.addEventListener('DOMContentLoaded', () => {
        // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
        const existingInterval = window.trainingInterval;
        if (existingInterval) {
            clearInterval(existingInterval);
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—É—á–µ–Ω–∏–µ
        startTraining();
    });
</script>