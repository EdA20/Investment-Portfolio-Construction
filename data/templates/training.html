<div class="container">
    <div class="step-indicator">
        <div class="step">1</div>
        <div class="step">2</div>
        <div class="step">3</div>
        <div class="step">4</div>
        <div class="step active">5</div>
    </div>
    <link rel="stylesheet" href="/static/style.css">

    <h2>ü§ñ –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏</h2>
    <div id="trainingStatus">
        <div class="loader"></div>
        <p style="text-align: center; color: #666;">–ò–¥–µ—Ç –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –∏ –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏...</p>
        <div class="progress-bar">
            <div class="progress"></div>
        </div>
    </div>
    
    <div id="result" style="display: none; opacity: 0; transform: translateY(20px); transition: opacity 0.8s ease, transform 0.8s ease;">
        <h3 style="color: var(--accent);">üéâ –û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</h3>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">üìà –ü–µ—Ä—Ñ–æ—Ä–º–∞–Ω—Å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</div>
                <div class="metric-value" id="strategy_perf"></div>
                <div class="metric-description">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">üìä –ü–µ—Ä—Ñ–æ—Ä–º–∞–Ω—Å –∏–Ω–¥–µ–∫—Å–∞</div>
                <div class="metric-value" id="bench_perf"></div>
                <div class="metric-description">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –∏–Ω–¥–µ–∫—Å–∞ –ú–æ—Å–±–∏—Ä–∂–∏</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">‚öñÔ∏è –ö–æ—ç—Ñ. –®–∞—Ä–ø–∞</div>
                <div class="metric-value" id="sharp_ratio"></div>
                <div class="metric-description">–†–∏—Å–∫-—Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">üìâ –ú–∞–∫—Å. –ø—Ä–æ—Å–∞–¥–∫–∞</div>
                <div class="metric-value" id="max_drawdown"></div>
                <div class="metric-description">–ù–∞–∏–±–æ–ª—å—à–µ–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">Œ≤ (–ë–µ—Ç–∞)</div>
                <div class="metric-value" id="beta"></div>
                <div class="metric-description">–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä—ã–Ω–∫–∞</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">üìå VaR (95%)</div>
                <div class="metric-value" id="var"></div>
                <div class="metric-description">–ú–∞–∫—Å. –ø–æ—Ç–µ—Ä—è —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 95%</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">‚ö†Ô∏è CVaR (95%)</div>
                <div class="metric-value" id="cvar"></div>
                <div class="metric-description">–°—Ä–µ–¥–Ω—è—è –ø–æ—Ç–µ—Ä—è –ø—Ä–∏ —Ö—É–¥—à–∏—Ö 5% —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤</div>
            </div>
        </div>

        <div class="feature-block">
            <h3>üìã –ë–∞–∑–æ–≤—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –º–æ–¥–µ–ª–∏</h3>
            <div id="baseFeaturesList" class="features-list"></div>
        </div>

        <div class="feature-block">
            <div class="chart-container">
                <h4>üìà –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</h4>
                <img id="strategyChart" class="chart-img" alt="–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏" 
                    style="display: block; margin: 0 auto;">
            </div>
        </div>
    </div>
</div>

<script>
    async function startTraining() {
        try {
            // 1. –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            const response = await fetch('/train', { method: 'POST' });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const { task_id } = await response.json();

            // 2. –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
            trackProgress(task_id);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –æ–±—É—á–µ–Ω–∏—è:', error);
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏');
        }
    }

    async function trackProgress(task_id) {
        const progressBar = document.querySelector('.progress');
        const interval = setInterval(async () => {
            try {
                // 3. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 1.5 —Å–µ–∫—É–Ω–¥—ã
                const response = await fetch(`/status/${task_id}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const status = await response.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                if (progressBar) {
                    progressBar.style.width = `${status.progress}%`;
                }
                
                // 4. –ï—Å–ª–∏ –æ–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
                if (status.status === 'completed') {
                    clearInterval(interval);
                    showResults(status);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
                clearInterval(interval);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ–±—É—á–µ–Ω–∏—è');
            }
        }, 1500);
    }

    function showResults(status) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
        document.getElementById('strategy_perf').innerHTML = formatPercent(status.strategy_perf);
        document.getElementById('bench_perf').innerHTML = formatPercent(status.bench_perf);
        document.getElementById('sharp_ratio').innerHTML = status.sharp_ratio.toFixed(2);
        document.getElementById('max_drawdown').innerHTML = formatPercent(status.max_drawdown);
        document.getElementById('beta').innerHTML = status.beta.toFixed(2);
        document.getElementById('var').innerHTML = formatPercent(status.var);
        document.getElementById('cvar').innerHTML = formatPercent(status.cvar);
        if (status.strategy_performance) {
            document.getElementById('strategyChart').src = 
                `data:image/png;base64,${status.strategy_performance}`;
        }

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
        const baseFeaturesContainer = document.getElementById('baseFeaturesList');
        if (status.base_feature_names && Array.isArray(status.base_feature_names)) {
            baseFeaturesContainer.innerHTML = '';
            status.base_feature_names.forEach(feature => {
                const tag = document.createElement('div');
                tag.className = 'feature-tag';
                tag.textContent = feature;
                baseFeaturesContainer.appendChild(tag);
            });
        } else {
            baseFeaturesContainer.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∏–∑–Ω–∞–∫–∞—Ö</p>';
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        setTimeout(() => {
            document.getElementById('trainingStatus').style.display = 'none';
            document.getElementById('result').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('result').style.opacity = 1;
                document.getElementById('result').style.transform = 'translateY(0)';
            }, 50);
        }, 500);
    }
    function formatPercent(value) {
        const formatted = (value * 100).toFixed(2) + '%';
        if (value > 0) {
            return `<span style="color: #4caf50;">${formatted}</span>`;
        } else if (value < 0) {
            return `<span style="color: #f44336;">${formatted}</span>`;
        }
        return formatted;
    }

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        
        const container = document.querySelector('.container');
        container.insertBefore(errorDiv, container.firstChild);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
        const restartBtn = document.createElement('button');
        restartBtn.className = 'btn';
        restartBtn.textContent = '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';
        restartBtn.onclick = () => location.reload();
        
        container.appendChild(restartBtn);
    }

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å
    document.addEventListener('DOMContentLoaded', () => {
        // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
        const existingInterval = window.trainingInterval;
        if (existingInterval) {
            clearInterval(existingInterval);
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—É—á–µ–Ω–∏–µ
        startTraining();
    });
</script>